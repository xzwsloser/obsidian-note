> 首先了解两个常用的概念:  [网关](https://www.itheima.com/news/20211130/153644.html)   [子网掩码](https://blog.csdn.net/modi000/article/details/127285958) 
1. `IP`协议的特点: 无状态,无连接,不保证可靠数据传输,尽力交付的,本章从`IP`数据报的结构和路由来介绍 `IP`协议
2. `IP`数据报的结构如下: 
![[Pasted image 20241203210826.png]]
下面解释一下几个比较关键的字段:
	- 版本号: `ipv4`默认为`4`
	- 头部长度
	- 服务类型: 根据应用层服务的要求确定,类似于定制化服务
	- 总长度
	- 标识: 用于分片,同一个分片下所有的数据报的标识相同
	- 协议: 报文中的上层协议
	- 源端`IP`地址
	- 目的端`IP`地址
3. 利用`tcpdump`抓取`ip`数据报报文,方法如下:
```shell
sudo tcpdump -ntx -i lo port 端口号# lo 表示本地环路
```
4. `IP`分片,`IP`数据包的大小受到`MTU`的影响,比较大的`IP`数据报会被分成一些比较小的`IP`数据报,`kernel`中的`IP`模块可以利用`IP`数据报中的三个字段把数据报分片和成为数据包,也就是标识,标志位(用于标识最后一个数据报分片的位置) , 以及片偏移,并且对于比较大的报文可能分片之后会复制内容中上层协议报文的头部而不会复制内容
5. `IP`路由过程,首先看`kernel`中`IP`模块的工作流程:
![[Pasted image 20241203213602.png]]
下面介绍几个比较重要的组成部分: 左边是数据报转发模块,一般来说是路由器的工作,另外一条线是处理发送给本机的报文
	- 路由表: 记录着源`IP`地址和目标`IP`地址的映射关系,在`Linux`下可以使用 `route`命令查看和操作路由表
6. `IP`转发的过程: 
		1. 检查`TTL`,看`TTL`是否为 `0`
		2. 查看数据报的严格源路由选择,如果设置了这一个选项,那么就需要发送一个`ICMP`源路由选择失败的报文给发送端
		3. `TTL`减少`1` 
		4. 处理`IP`头部信息
		5. 执行`IP`分片操作
7. `ICMP`重定向,重定向报文如下,上面的头部是`ICMP`报文的固定结构:
![[Pasted image 20241203214632.png]]
8. `ipv6`协议的头部(说明可以查看 `P27`):
![[Pasted image 20241203214725.png]]
